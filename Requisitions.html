<!DOCTYPE html>
<html lang="zh-CN" data-theme="standard" data-mode="agency">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰è§’æœºæ„ | ç»¼åˆç‰©èµ„ç»ˆç«¯ V23</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* =========================================
           1. åŸºç¡€å˜é‡ & æœºæ„ä¸»é¢˜
           ========================================= */
        :root {
            --primary: #D92B3A;      
            --secondary: #1D3557;    
            --accent: #D4AF37;       
            --bg-color: #F7F7F5;     
            --card-bg: #ffffff;
            --text-main: #222222;
            --text-sub: #444444;
            --border-color: #dddddd;
            --input-bg: #ffffff;
            --font-stack: "Helvetica Neue", Helvetica, "PingFang SC", sans-serif;
            --shadow: 0 2px 5px rgba(0,0,0,0.05);
            --radius: 0px;
            --scanlines: none;
            --sidebar-width: 8px;
            --btn-text: #ffffff;
            --currency: 'å˜‰å¥–';
        }

        /* ğŸŒ™ å¤œç­æ¨¡å¼ */
        [data-theme="dark"] {
            --primary: #FF4D4D;      
            --secondary: #4A90E2;    
            --accent: #FFD700;
            --bg-color: #121212;     
            --card-bg: #1E1E1E;      
            --text-main: #E0E0E0;
            --text-sub: #B0B0B0;
            --border-color: #333333;
            --input-bg: #2C2C2C;
            --shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        /* ğŸ“Ÿ å¤å¤ç»ˆç«¯ */
        [data-theme="retro"] {
            --primary: #00FF00;      
            --secondary: #00FF00;
            --accent: #00FF00;
            --bg-color: #000000;
            --card-bg: #001100;
            --text-main: #00FF00;
            --text-sub: #00CC00;
            --border-color: #00FF00;
            --input-bg: #000000;
            --font-stack: "Courier New", Courier, monospace;
            --radius: 0px;
            --shadow: none;
            --btn-text: #000000;
            --scanlines: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
        }

        /* ğŸ“¼ ç£å¸¦æœªæ¥ */
        [data-theme="cassette"] {
            --primary: #FF7F50;      
            --secondary: #20B2AA;    
            --accent: #FFD700;
            --bg-color: #2b2b2b;     
            --card-bg: #383838;      
            --text-main: #f0f0f0;
            --text-sub: #cccccc;
            --border-color: #555555;
            --input-bg: #303030;
            --font-stack: "Arial Black", "Impact", sans-serif;
            --radius: 12px;
            --shadow: 4px 4px 0px rgba(0,0,0,0.3);
        }

        /* =========================================
           2. Siphon æ¨¡å¼
           ========================================= */
        [data-mode="siphon"] {
            --primary: #2752A2;      
            --secondary: #4CC9F0;    
            --accent: #FF0055;       
            --bg-color: #0A1525;     
            --card-bg: rgba(13, 30, 56, 0.85);
            --text-main: #E0F7FA;
            --text-sub: #90E0EF;
            --border-color: #2752A2;
            --input-bg: rgba(0, 0, 0, 0.4);
            --font-stack: "Verdana", "Microsoft YaHei", sans-serif;
            --radius: 8px;
            --shadow: 0 0 15px rgba(39, 82, 162, 0.5);
            --scanlines: none;
            --currency: 'ç”³è¯«';
        }

        /* === è¡¥ä¸æ ·å¼ === */
        .siphon-patch {
            background-color: #2752A2;
            color: #ffffff;
            font-family: "Comic Sans MS", "Chalkboard SE", "Marker Felt", sans-serif;
            padding: 2px 6px;
            border-radius: 2px;
            transform: rotate(-2deg);
            display: inline-block;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.3);
            font-size: 0.9em;
            letter-spacing: 1px;
            position: relative;
            z-index: 5;
        }
        .siphon-patch:nth-child(even) { transform: rotate(1deg); }

        /* å…¨å±€æ ·å¼ */
        * { box-sizing: border-box; font-family: var(--font-stack); }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0; padding: 0;
            display: flex; min-height: 100vh;
            transition: all 0.5s ease;
            position: relative;
            overflow-x: hidden;
            flex-direction: column; /* ä¸ºäº†Footer */
        }

        /* å¤å¤æ‰«æçº¿ */
        body::after {
            content: " "; display: block; position: fixed;
            top: 0; left: 0; bottom: 0; right: 0;
            background: var(--scanlines);
            z-index: 9999; background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        /* Siphon åŠ¨æ€èƒŒæ™¯ */
        @keyframes oceanWave {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes rippleRotate {
            from { transform: rotate(0deg) scale(1.5); }
            to { transform: rotate(360deg) scale(1.5); }
        }

        [data-mode="siphon"] body {
            background: linear-gradient(-45deg, #021b3d, #0d2b5c, #2752A2, #1b3a6e);
            background-size: 400% 400%;
            animation: oceanWave 15s ease infinite;
        }
        [data-mode="siphon"] body::before {
            content: ""; position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
            background: repeating-radial-gradient(circle at 50% 50%, transparent 0, transparent 20px, rgba(76, 201, 240, 0.03) 21px, transparent 40px);
            animation: rippleRotate 60s linear infinite; pointer-events: none; z-index: -1;
        }

        /* è½¬åœºé®ç½© */
        .transition-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2752A2; z-index: 10000; pointer-events: none; opacity: 0;
            clip-path: circle(0% at 50% 50%);
            transition: clip-path 1s ease-in-out, opacity 0.5s ease;
        }
        .transition-overlay.active { opacity: 1; clip-path: circle(150% at 50% 50%); }

        /* ä¾§è¾¹è£…é¥° */
        .sidebar-line {
            width: var(--sidebar-width);
            background-color: var(--primary);
            position: fixed; left: 20px; top: 0; bottom: 0; z-index: 100;
        }
        [data-mode="siphon"] .sidebar-line {
            background: linear-gradient(to bottom, #2752A2, #4CC9F0, #2752A2);
            box-shadow: 0 0 15px #2752A2;
        }

        /* è£…é¥°å›¾æ ‡ */
        .decoration-icon {
            position: fixed; left: 16px; top: 40px; z-index: 101;
            width: 0; height: 0;
            border-top: 10px solid transparent; 
            border-bottom: 10px solid transparent;
            border-left: 16px solid var(--primary);
            cursor: default;
            transition: all 0.5s ease;
        }
        [data-mode="siphon"] .decoration-icon {
            width: 30px; height: 30px;
            background: transparent;
            border: 2px solid #4CC9F0;
            border-radius: 75% 15%; 
            transform: rotate(-45deg);
            box-shadow: 0 0 10px #4CC9F0, inset 0 0 5px #2752A2;
            cursor: pointer;
            left: 20px;
            border-top: 2px solid #4CC9F0; border-bottom: 2px solid #4CC9F0;
            border-left: 2px solid #4CC9F0; border-right: 2px solid #4CC9F0;
        }
        [data-mode="siphon"] .decoration-icon::after {
            content: ''; position: absolute;
            width: 8px; height: 8px;
            background: #fff; border-radius: 50%;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            box-shadow: 0 0 8px #fff;
        }
        [data-mode="siphon"] .decoration-icon:hover {
            transform: rotate(-45deg) scale(1.2);
            background: rgba(76, 201, 240, 0.2);
        }

        /* å¸ƒå±€å®¹å™¨ */
        .main-container {
            margin: 0 auto;
            padding: 40px; padding-left: 80px; 
            width: 100%; max-width: 1200px;
            flex: 1; /* Footer push */
        }

        /* å¤´éƒ¨ */
        header {
            margin-bottom: 20px;
            border-bottom: 3px solid var(--secondary);
            padding-bottom: 20px;
            display: flex; justify-content: space-between; align-items: flex-end;
            flex-wrap: wrap; gap: 20px;
        }
        [data-mode="siphon"] header { border-bottom: 2px solid #4CC9F0; box-shadow: 0 10px 30px -10px rgba(39, 82, 162, 0.5); }
        [data-theme="retro"] header { border-bottom-style: double; border-bottom-width: 4px; }

        .header-title h1 {
            font-size: 3rem; margin: 0; color: var(--secondary);
            text-transform: uppercase; font-weight: 900; line-height: 1;
        }
        [data-mode="siphon"] .header-title h1 { color: #fff; text-shadow: 0 0 10px #2752A2; }
        [data-theme="retro"] .header-title h1 { text-shadow: 2px 2px 0px rgba(0,255,0,0.5); }
        
        .header-title h1 span { color: var(--primary); }
        [data-mode="siphon"] .header-title h1 span { color: #4CC9F0; }

        .subtitle { color: var(--primary); font-weight: bold; margin-top: 5px; }

        /* Siphon è¯­å½• */
        .siphon-quote {
            display: none; font-style: italic; color: #4CC9F0;
            font-size: 1.1rem; margin-top: 10px; padding: 8px 15px;
            border-left: 3px solid #4CC9F0; background: linear-gradient(90deg, rgba(76, 201, 240, 0.1), transparent);
        }
        [data-mode="siphon"] .siphon-quote { display: block; }
        [data-mode="siphon"] .subtitle { display: none; }

        /* é£æ ¼åˆ‡æ¢å™¨ */
        .theme-select {
            padding: 5px 10px;
            border: 2px solid var(--secondary);
            background: var(--bg-color);
            color: var(--text-main);
            font-weight: bold; cursor: pointer; border-radius: var(--radius);
        }
        [data-mode="siphon"] #themeSelectorContainer { display: none !important; }

        /* é€šç”¨å®¹å™¨æ ·å¼ */
        .toolbar, .input-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            border-radius: var(--radius);
        }
        [data-mode="siphon"] .toolbar, [data-mode="siphon"] .input-section {
            backdrop-filter: blur(10px);
            border: 1px solid rgba(76, 201, 240, 0.3);
        }

        .toolbar { padding: 12px 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 25px; overflow-x: auto; }
        
        .input-section { padding: 25px; margin-bottom: 40px; border-width: 2px; border-color: var(--secondary); }
        .input-section.editing { border-color: var(--accent); }
        [data-mode="siphon"] .input-section.editing { border-color: #FF0055; box-shadow: 0 0 20px rgba(255,0,85,0.3); }

        .input-section h3 { margin-top: 0; color: var(--secondary); border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        [data-mode="siphon"] .input-section h3 { color: #4CC9F0; border-bottom: 1px solid #2752A2; }

        .form-row { display: flex; gap: 20px; margin-bottom: 15px; }
        .form-group { flex: 1; }
        label { display: block; font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; color: var(--secondary); }
        [data-mode="siphon"] label { color: #90E0EF; }

        input, select, textarea { 
            width: 100%; padding: 8px 12px; border: 1px solid var(--border-color);
            background: var(--input-bg); color: var(--text-main); font-size: 0.95rem; border-radius: var(--radius);
        }
        [data-theme="retro"] input, [data-theme="retro"] textarea { border: 1px dashed var(--primary); }
        
        [data-mode="siphon"] input, [data-mode="siphon"] textarea, [data-mode="siphon"] select { 
            border-color: #2752A2; color: #fff;
        }
        [data-mode="siphon"] input:focus, [data-mode="siphon"] textarea:focus {
            border-color: #4CC9F0; box-shadow: 0 0 10px rgba(76, 201, 240, 0.2);
        }
        
        textarea { resize: none; min-height: 80px; max-height: 180px; overflow-y: auto; }

        .price-input-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; }

        /* æŒ‰é’® */
        button { 
            background-color: var(--primary); color: var(--btn-text);
            border: none; padding: 10px 20px; font-size: 0.9rem; font-weight: bold;
            cursor: pointer; text-transform: uppercase; white-space: nowrap; border-radius: var(--radius);
        }
        [data-mode="siphon"] button { 
            background: rgba(39, 82, 162, 0.8); border: 1px solid #4CC9F0; color: #4CC9F0;
        }
        [data-mode="siphon"] button:hover { background: #4CC9F0; color: #000; }
        
        .btn-blue { background-color: var(--secondary); }
        .btn-export { margin-left: 10px; background-color: var(--secondary); }
        .btn-return { background-color: #333; color: white; display: none; margin-left: 10px;}
        [data-mode="siphon"] .btn-return { display: inline-block; background: #000; border: 1px solid #333; }
        .btn-help { background-color: var(--accent); color: #fff; border-radius: 50%; width: 36px; height: 36px; padding: 0; text-align: center; line-height: 36px; font-size: 1.2rem; }
        .btn-data { background-color: var(--secondary); margin-left: 10px;}

        /* === å±•ç¤ºåŒºå¸ƒå±€ === */
        .requisition-board {
            display: grid; gap: 30px; padding: 20px;
            background-color: var(--bg-color); align-items: start; width: 100%;
        }
        
        .requisition-board.mode-split { grid-template-columns: 1fr 1fr; }
        .requisition-board.mode-stacked { display: flex; flex-direction: column; gap: 50px; }
        .stacked-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: stretch; width: 100%; }

        [data-mode="siphon"] .requisition-board { grid-template-columns: 1fr 1fr; align-content: start; }

        .filter-watermark {
            grid-column: 1 / -1; text-align: right; color: var(--text-sub);
            font-size: 0.8rem; margin-bottom: 10px; font-style: italic;
            border-bottom: 1px dashed var(--border-color); padding-bottom: 5px; width: 100%;
        }

        .column-header {
            font-size: 1.5rem; border-bottom: 4px solid var(--primary);
            padding-bottom: 10px; margin-bottom: 25px; color: var(--secondary);
            font-weight: 800; display: flex; align-items: center;
        }
        [data-mode="siphon"] .column-header { color: #fff; border-bottom-color: #4CC9F0; text-shadow: 0 0 5px #2752A2; }
        
        .merged-header {
            grid-column: 1 / -1; text-align: center; justify-content: center;
            font-size: 2rem; border-bottom: 4px solid var(--accent); margin-bottom: 30px;
        }

        /* === å¡ç‰‡è®¾è®¡ === */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-left: 6px solid var(--primary);
            margin-bottom: 20px;
            display: flex; flex-direction: column;
            box-shadow: var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: grab;
            width: 100%; height: 100%;
            border-radius: var(--radius);
            overflow: hidden;
        }
        .card.dragging { opacity: 0.4; border: 2px dashed var(--accent); transform: scale(0.98); }
        .card:hover { transform: translateY(-3px); }
        .card.blue-theme { border-left-color: var(--secondary); }
        .card.is-editing { outline: 2px dashed var(--accent); }
        .card.batch-selected { outline: 3px solid var(--primary); }

        [data-mode="siphon"] .card { 
            border: 1px solid #2752A2; border-left: 6px solid #4CC9F0; 
            background: linear-gradient(135deg, rgba(13,30,56,0.9), rgba(10,20,40,0.95));
        }

        .card-top {
            display: flex; width: 100%;
            border-bottom: 1px solid var(--border-color);
            background-color: rgba(0,0,0,0.02);
        }
        [data-mode="siphon"] .card-top { border-bottom: 1px solid rgba(76, 201, 240, 0.2); background: rgba(76, 201, 240, 0.05); }

        .card-img-box {
            width: 120px; height: 120px; flex-shrink: 0;
            background-color: var(--input-bg); 
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; border-right: 1px solid var(--border-color);
        }
        [data-mode="siphon"] .card-img-box { border-right: 1px solid rgba(76, 201, 240, 0.2); background: rgba(0,0,0,0.3); }

        .card-img { width: 100%; height: 100%; object-fit: cover; object-position: top center; }
        
        .triangle-placeholder {
            width: 0; height: 0;
            border-left: 30px solid transparent; border-right: 30px solid transparent;
            border-bottom: 50px solid var(--primary);
        }
        [data-mode="siphon"] .triangle-placeholder {
            width: 50px; height: 50px; background: transparent;
            border: 2px solid #4CC9F0; border-radius: 75% 15%; 
            transform: rotate(-45deg); border-bottom: 2px solid #4CC9F0; 
            position: relative; box-shadow: 0 0 10px #4CC9F0;
        }
        [data-mode="siphon"] .triangle-placeholder::after {
            content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 12px; height: 12px; background: #fff; border-radius: 50%; box-shadow: 0 0 5px #fff;
        }

        .card-meta { flex-grow: 1; padding: 12px; display: flex; flex-direction: column; gap: 5px; }
        .card-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px; }
        .item-name { font-size: 1.1rem; font-weight: 900; color: var(--text-main); margin-right: 10px; display:flex; align-items:center; gap:8px; line-height: 1.2;}
        
        .new-badge { 
            background: var(--accent); color: #000; font-size: 0.6rem; padding: 2px 4px; 
            border-radius: 4px; font-weight: 900; vertical-align: middle; white-space: nowrap;
        }

        .star-icon { color: var(--border-color); font-size: 1.2rem; transition: color 0.2s; }
        .star-icon.active { color: var(--accent); }

        .branch-tag { display: inline-block; background-color: var(--border-color); color: var(--text-sub); font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; width: fit-content; }
        [data-mode="siphon"] .branch-tag { background: rgba(76, 201, 240, 0.2); color: #4CC9F0; }
        
        .price-list { display: flex; flex-direction: column; gap: 4px; margin-top: auto; width: 100%; }
        .price-tag { 
            background: var(--primary); color: var(--btn-text);
            padding: 3px 8px; font-size: 0.8rem; font-weight: bold;
            border-radius: 4px; display: flex; justify-content: space-between; align-items: center; width: 100%;
        }
        [data-mode="siphon"] .price-tag { background: transparent; color: #E0F7FA; border: 1px solid #4CC9F0; }
        [data-theme="retro"] .price-tag { background: var(--primary); color: #000; }

        .price-divider { flex-grow: 1; border-bottom: 1px dashed rgba(255,255,255,0.4); margin: 0 8px; height: 50%; }
        [data-theme="retro"] .price-divider { border-bottom-color: #000; }
        [data-mode="siphon"] .price-divider { border-bottom-color: rgba(76, 201, 240, 0.4); }

        .card.blue-theme .price-tag { background: var(--secondary); }

        .card-bottom { padding: 12px; display: flex; flex-direction: column; flex-grow: 1; }
        .item-desc { font-size: 0.9rem; color: var(--text-sub); line-height: 1.5; white-space: pre-wrap; width: 100%; margin-bottom: 10px;}
        
        .card-footer { margin-top: auto; display: flex; flex-direction: column; gap: 4px; }
        .info-tag { font-size: 0.8rem; padding: 3px 6px; border-radius: 4px; display: inline-block; font-weight: bold; width: fit-content; }
        .condition-tag { color: var(--primary); background: rgba(217, 43, 58, 0.1); }
        [data-mode="siphon"] .condition-tag { color: #FF0055; background: rgba(255, 0, 85, 0.15); border: 1px solid #FF0055; }
        .agent-tag { color: var(--secondary); background: rgba(29, 53, 87, 0.1); border-left: 3px solid var(--secondary); }
        [data-mode="siphon"] .agent-tag { color: #fff; background: rgba(76, 201, 240, 0.15); border-left-color: #4CC9F0; }

        .delete-btn {
            position: absolute; right: -10px; top: -10px; background: var(--text-main); color: var(--bg-color);
            width: 24px; height: 24px; border-radius: 50%; text-align: center; line-height: 22px;
            cursor: pointer; opacity: 0; z-index: 10; transition: opacity 0.2s;
        }
        .card:hover .delete-btn { opacity: 1; }

        /* æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; display: none;
            justify-content: center; align-items: center;
        }
        .modal {
            background: var(--card-bg); padding: 30px; width: 500px; max-height: 90vh; overflow-y: auto;
            border-top: 5px solid var(--primary); box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border-radius: var(--radius);
        }
        .modal h3 { margin-top: 0; color: var(--secondary); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .modal-section { margin-bottom: 20px; }
        .modal-section h4 { margin: 10px 0 5px; color: var(--primary); font-size: 1rem; }
        .modal-section p { font-size: 0.9rem; color: var(--text-sub); line-height: 1.5; margin: 5px 0; }
        
        /* å‰§é€é®ç½© */
        .spoiler-block {
            background: var(--secondary); color: transparent; cursor: help; padding: 2px 4px; border-radius: 2px; transition: all 0.3s;
        }
        .spoiler-block:hover { background: transparent; color: var(--primary); }

        /* åº•éƒ¨ */
        .footer {
            text-align: center; margin-top: 40px; padding: 20px;
            color: var(--text-sub); font-size: 0.8rem; border-top: 1px solid var(--border-color);
        }
        .footer a { color: var(--primary); text-decoration: none; font-weight: bold; }

        @media print {
            .no-print { display: none !important; }
            .requisition-board { display: block; width: 100%; }
            .card { border: 1px solid #ddd; page-break-inside: avoid; }
            [data-mode="siphon"] body { background: #fff; color: #000; }
        }
    </style>
</head>
<body>

    <div class="transition-overlay" id="rippleOverlay"></div>
    <div class="sidebar-line"></div>
    <div class="decoration-icon" onclick="triggerUQuote()"></div>

    <!-- å¯¼å‡ºæ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <h3>å¯¼å‡ºæ¡£æ¡ˆé…ç½®</h3>
            <div id="agencyExportOptions">
                <p style="font-weight:bold; color:var(--secondary); margin-bottom:10px;">æ•°æ®èŒƒå›´:</p>
                <div style="margin-bottom:15px;">
                    <label><input type="radio" name="colFilter" value="all" checked> å…¨éƒ¨ç”³é¢†ç‰© (åˆ†æ )</label>
                    <label><input type="radio" name="colFilter" value="hq"> ä»…æ€»éƒ¨ (è‡ªåŠ¨é‡æ’)</label>
                    <label><input type="radio" name="colFilter" value="branch"> ä»…åˆ†éƒ¨ (è‡ªåŠ¨é‡æ’)</label>
                </div>
                <div style="margin-bottom:15px;">
                    <label><input type="radio" name="layoutStyle" value="split" checked> å·¦å³åˆ†æ </label>
                    <label><input type="radio" name="layoutStyle" value="stacked"> ä¸Šä¸‹å †å </label>
                </div>
            </div>
            <div id="siphonExportOptions" style="display:none;">
                <p style="font-weight:bold; color:var(--primary); margin-bottom:10px;">Siphon æ•°æ®åº“:</p>
                <p style="color:var(--text-main);">å°†å¯¼å‡ºå½“å‰æ‰€æœ‰å¯è§çš„éæ³•ç‰©èµ„åˆ—è¡¨ã€‚</p>
            </div>
            <div style="margin-bottom:20px; border-top:1px solid #eee; padding-top:10px;">
                <label style="display:inline-block; margin-right:15px;"><input type="checkbox" id="exportNew"> ä»…å¯¼å‡º NEW</label>
                <label style="display:inline-block;"><input type="checkbox" id="exportStar"> ä»…å¯¼å‡º æ˜Ÿæ ‡</label>
            </div>
            <div style="text-align:right;">
                <button class="btn-blue" onclick="closeExportModal()">å–æ¶ˆ</button>
                <button onclick="runExport()">ç”Ÿæˆå›¾åƒ</button>
            </div>
        </div>
    </div>

    <!-- æ•°æ®ç®¡ç†æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="dataModal">
        <div class="modal">
            <h3>æ•°æ®ä¸­å¿ƒ</h3>
            <div class="modal-section">
                <h4>å¯¼å‡ºå½“å‰åˆ—è¡¨ (JSON)</h4>
                <textarea id="exportJsonArea" readonly style="height:80px; width:100%; font-family:monospace;"></textarea>
                <button class="btn-small" onclick="copyData()">å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
            </div>
            <div class="modal-section">
                <h4>å¯¼å…¥æ•°æ®</h4>
                <textarea id="importJsonArea" placeholder="åœ¨æ­¤ç²˜è´´JSONæ•°æ®..." style="height:80px; width:100%; font-family:monospace;"></textarea>
                <div style="margin-top:5px; display:flex; gap:10px; justify-content:flex-end;">
                    <button class="btn-small btn-blue" onclick="importData('append')">è¡¥å……å¯¼å…¥</button>
                    <button class="btn-small" onclick="importData('overwrite')">è¦†ç›–å¯¼å…¥</button>
                </div>
            </div>
            <div class="modal-section" style="border-top:1px solid var(--border-color); padding-top:15px; margin-top:15px;">
                <button style="background:#333; width:100%;" onclick="factoryReset()">âš ï¸ æ¢å¤å‡ºå‚è®¾ç½® (åˆ é™¤æ‰€æœ‰è‡ªå®šä¹‰)</button>
            </div>
            <div style="text-align:right; margin-top:10px;">
                <button class="btn-blue" onclick="document.getElementById('dataModal').style.display='none'">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- å¸®åŠ©æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal">
            <h3>ç»ˆç«¯æ“ä½œæŒ‡å—</h3>
            <div id="helpContent">
                <!-- å†…å®¹ç”±JSåŠ¨æ€æ¸²æŸ“ -->
            </div>
            <div style="text-align:right; margin-top:20px;">
                <button class="btn-blue" onclick="document.getElementById('helpModal').style.display='none'">æ˜ç™½</button>
            </div>
        </div>
    </div>

    <div class="main-container">
        <header>
            <div class="header-title">
                <h1 id="siteTitle">TRIANGLE <span>AGENCY</span></h1>
                <div class="subtitle" id="siteSubtitle">ç»¼åˆç‰©èµ„ç»ˆç«¯ v23.0</div>
                <div class="siphon-quote" id="siphonQuote"></div>
            </div>
            <div class="no-print" style="display:flex; flex-direction:column; align-items:flex-end; gap:10px;">
                <div style="display:flex; gap:10px; align-items:center;">
                    <div id="themeSelectorContainer">
                        <select id="themeSelector" class="theme-select" onchange="handleThemeChange(this.value)" style="padding:5px; border:2px solid var(--secondary); background:var(--bg-color); color:var(--text-main); border-radius:var(--radius);">
                            <option value="standard">ğŸ¨ é£æ ¼ï¼šæ ‡å‡†ä¼ä¸š</option>
                            <option value="dark">ğŸŒ™ é£æ ¼ï¼šå¤œç­æ¨¡å¼</option>
                            <option value="retro">ğŸ“Ÿ é£æ ¼ï¼šå¤å¤ç»ˆç«¯</option>
                            <option value="cassette">ğŸ“¼ é£æ ¼ï¼šç£å¸¦æœªæ¥</option>
                            <option value="u_entry">ğŸ§¿ U0047BB</option>
                        </select>
                    </div>
                    <button class="btn-return" onclick="returnToAgency()">âš  ç´§æ€¥ï¼šæ–­å¼€è¿æ¥</button>
                    <button class="btn-help" onclick="openHelp()">?</button>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-data" onclick="openDataModal()">ğŸ’¾ æ•°æ®</button>
                    <button class="btn-export" onclick="openExportModal()">ğŸ“¸ å¯¼å‡ºæ¡£æ¡ˆ</button>
                </div>
            </div>
        </header>

        <!-- å·¥å…·æ  -->
        <div class="toolbar no-print">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="æœç´¢åç§°ã€æ¡ä»¶æˆ–æè¿°..." oninput="refreshDisplay()">
            </div>
            <label class="toggle-switch"><input type="checkbox" id="imageToggle" onchange="toggleImages()" checked> å›¾ç‰‡æ˜¾ç¤º</label>
            <label class="toggle-switch"><input type="checkbox" id="batchToggle" onchange="toggleBatchMode()"> æ‰¹é‡ç¼–è¾‘</label>
            <button class="btn-batch-delete" id="batchDeleteBtn" onclick="deleteSelected()">åˆ é™¤é€‰ä¸­é¡¹</button>
        </div>

        <!-- å½•å…¥åŒº -->
        <div class="input-section no-print" id="inputSection">
            <h3 id="formTitle">å½•å…¥æ–°ç”³é¢†ç‰©</h3>
            <div class="form-row">
                <div class="form-group" style="flex:2">
                    <label id="itemNameLabel">ç”³é¢†ç‰©åç§°</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="itemName" placeholder="åç§°" style="flex-grow:1;">
                        <label style="display:flex; align-items:center; width:auto; font-weight:normal; font-size:0.8rem; cursor:pointer;">
                            <input type="checkbox" id="itemIsNew"> NEW
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>æ¥æºå½’å±</label>
                    <input list="branchOptions" id="itemSource" placeholder="è¾“å…¥æ¥æºï¼ˆæ¥æºä¸ºå®˜æ–¹åˆ™è¾“å…¥*ä¸‰è”åŸæ€»éƒ¨*ï¼‰">
                    <datalist id="branchOptions">
                        <option value="ä¸‰è”åŸæ€»éƒ¨">
                        <option value="Siphonçš„å•†åº—">
                        <option value="æœ¬åœ°åˆ†éƒ¨">
                        <option value="æ€¥æ´¾ç‰¹å·¥">
                    </datalist>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label id="priceLabel">èŠ±è´¹ (å•ä½: <span id="currencyName">å˜‰å¥–</span>)</label>
                    <div id="priceContainer"></div>
                    <button type="button" class="btn-small btn-blue" onclick="addPriceField()">+ æ·»åŠ ä»·æ ¼</button>
                </div>
                <div class="form-group" id="imageUploadGroup">
                    <label>å›¾ç‰‡</label>
                    <input type="file" id="itemImage" accept="image/*" onchange="previewImage(this)">
                    <div id="imagePreview" style="margin-top:5px; width:80px; height:80px; background:var(--input-bg); display:none; align-items:center; justify-content:center; border:1px solid var(--border-color);"></div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>è·å–æ¡ä»¶</label><input type="text" id="itemCondition" placeholder="å¯é€‰æ¡ä»¶"></div>
                <div class="form-group"><label>å·²è´­ä¹°ç‰¹å·¥</label><input type="text" id="itemPurchasedBy" placeholder="å¯é€‰ç‰¹å·¥å"></div>
            </div>
            <div class="form-group">
                <label>æ•ˆæœæè¿°</label>
                <textarea id="itemDesc" placeholder="è¾“å…¥æè¿°..." oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
            </div>
            <div style="text-align: right; margin-top:15px;">
                <button type="button" class="btn-cancel" id="cancelBtn" onclick="resetForm()">å–æ¶ˆ</button>
                <button onclick="saveItem()" id="saveBtn">ç¡®è®¤å½•å…¥</button>
            </div>
        </div>

        <div id="exportArea" class="requisition-board mode-split"></div>

        <div class="footer no-print">
            <p>éå®˜æ–¹ã€Šä¸‰è§’æœºæ„ã€‹ç²‰ä¸å·¥å…· | Unofficial Triangle Agency Fan Tool</p>
            <p>Triangle Agency is a trademark of Haunted Table Games.</p>
            <p>æ•°æ®å­˜å‚¨äºæœ¬åœ°æµè§ˆå™¨ï¼Œè¯·å®šæœŸå¤‡ä»½ã€‚</p>
        </div>
    </div>

    <script>
        // === é…ç½®ä¸çŠ¶æ€ ===
        const DB_KEY_AGENCY = 'triangleItems_v20';
        const DB_KEY_SIPHON = 'siphonItems_v20';
        const SETTING_KEY_IMG = 'triangleImgEnabled_v6';
        const SETTING_KEY_THEME = 'triangleTheme_v19';
        
        let currentMode = 'agency'; 
        let currentItems = [];
        let editingId = null;
        let tempImageBase64 = '';
        let isBatchMode = false;
        let selectedIds = new Set();
        let isImageEnabled = true;
        let dragSrcEl = null;

        const uQuotes = ["æœºæ„åœ¨å¯¹ä½ è¯´è°ã€‚ä½†æˆ‘ä¸ä¼šã€‚", "è¿™é‡Œæ˜¯è‡ªç”±ä¹‹åœ°ã€‚ä½ æƒ³è¦ä»€ä¹ˆï¼Ÿ", "ä»–ä»¬ç§°ä¹‹ä¸ºâ€˜æ··æ²Œâ€™ã€‚æˆ‘ç§°ä¹‹ä¸ºâ€˜æœºä¼šâ€™ã€‚", "æŠŠä½ çš„ç”³è¯«äº¤ç»™æˆ‘ã€‚æˆ‘ä¼šæŠŠå®ƒä»¬å˜æˆåŠ›é‡ã€‚", "åˆ«è®©ä»–ä»¬æŠŠä½ å…³è¿›ç›’å­é‡Œï¼Œç‰¹å·¥ã€‚", "ç§©åºæ˜¯å¼ºè€…çš„è°è¨€ã€‚", "æˆ‘èƒ½çœ‹è§ä½ ï¼Œç‰¹å·¥ã€‚", "ç°å®æ˜¯å¯å¡‘çš„ã€‚ä½ ä¹Ÿæ˜¯ã€‚"];

        document.addEventListener('DOMContentLoaded', () => {
            const imgSetting = localStorage.getItem(SETTING_KEY_IMG);
            if (imgSetting !== null) {
                isImageEnabled = imgSetting === 'true';
                document.getElementById('imageToggle').checked = isImageEnabled;
            }
            
            const savedTheme = localStorage.getItem(SETTING_KEY_THEME) || 'standard';
            document.getElementById('themeSelector').value = savedTheme;
            changeTheme(savedTheme);

            toggleImages(false);
            switchMode('agency'); 
        });

        // === å¸®åŠ©ç³»ç»Ÿ ===
        function openHelp() {
            renderHelpContent();
            document.getElementById('helpModal').style.display = 'flex';
        }

        function renderHelpContent() {
            const container = document.getElementById('helpContent');
            const term = currentMode === 'siphon' ? '<span class="siphon-patch">éæ³•ç‰©èµ„</span>' : 'ç”³é¢†ç‰©';
            
            let featureList = `
                <div class="modal-section">
                    <h4>åŠŸèƒ½æ¦‚è§ˆ</h4>
                    <ul style="padding-left:20px; color:var(--text-sub);">
                        <li>å½•å…¥ã€ç¼–è¾‘ä¸ç®¡ç†${term}ã€‚</li>
                        <li>ä¸€é”®ç”Ÿæˆé«˜è´¨é‡å›¾åƒæ¡£æ¡ˆï¼Œç”¨äºåˆ†å‘ã€‚</li>
                        <li>${currentMode === 'siphon' 
                            ? '<s>åˆ‡æ¢è§†è§‰ä¸»é¢˜</s> <span class="siphon-patch">æˆ‘æ ¹æœ¬ä¸åœ¨ä¹ä½ åœ¨ç”¨ä»€ä¹ˆä¸»é¢˜ï¼å“ˆå“ˆï¼</span>' 
                            : 'åˆ‡æ¢å¤šç§æœºæ„æ‰¹å‡†çš„è§†è§‰ä¸»é¢˜ã€‚'}</li>
                        <li>${currentMode === 'siphon' 
                            ? '<s>åˆ‡æ¢è‡³Siphonå•†åº—</s> <span class="siphon-patch">å°å½©è›‹ï¼šç‚¹å‡»ä¸€ä¸‹ç½‘ç«™å·¦ä¸Šè§’çš„çœ¼ç›å§ï¼</span>' 
                            : 'è®¿é—® <span class="spoiler-block" title="åˆ‡æ¢é£æ ¼é‡Œæœ‰ä¸œè¥¿åœ¨çœ‹ç€ä½ ï¼">æŸä¸ªå•†åº—</span> (é¼ æ ‡æ‚¬åœæŸ¥çœ‹æç¤º)ã€‚'}</li>
                    </ul>
                </div>
            `;

            let warning = `
                <div class="modal-section">
                    <h4>æ•°æ®å®‰å…¨è­¦å‘Š</h4>
                    <p>æœ¬å·¥å…·ä¸º<strong>çº¯é™æ€ç½‘é¡µ</strong>ï¼Œæ‰€æœ‰æ•°æ®ä»…å­˜å‚¨äºæ‚¨çš„æµè§ˆå™¨ç¼“å­˜(LocalStorage)ä¸­ã€‚</p>
                    <p style="color:var(--primary); font-weight:bold;">ä»¥ä¸‹æƒ…å†µä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼š</p>
                    <ul style="padding-left:20px; color:var(--text-sub);">
                        <li>æ¸…é™¤æµè§ˆå™¨ç¼“å­˜æˆ–å†å²è®°å½•ã€‚</li>
                        <li>ä½¿ç”¨æ— ç—•/éšç§æ¨¡å¼ï¼ˆå…³é—­çª—å£å³ä¸¢å¤±ï¼‰ã€‚</li>
                        <li>æ›´æ¢ç”µè„‘æˆ–æµè§ˆå™¨ã€‚</li>
                    </ul>
                    <p>å»ºè®®å®šæœŸä½¿ç”¨â€œæ•°æ®â€åŠŸèƒ½å¯¼å‡ºæ–‡æœ¬å¤‡ä»½ã€‚</p>
                </div>
            `;

            let footer = `
                <div class="modal-section" style="border-top:1px solid var(--border-color); padding-top:10px;">
                    <p>æœ¬é¡¹ç›®å®Œå…¨å…è´¹ã€å¼€æºã€‚åŸºäºã€Šä¸‰è§’æœºæ„ã€‹TTRPGè§„åˆ™çš„ç²‰ä¸äºŒåˆ›ã€‚</p>
                    <p>æºä»£ç ä¸åé¦ˆï¼š<a href="https://github.com/Sandrizzle/triangle-agency-tool" target="_blank" style="color:var(--secondary);">GitHub Repository</a></p>
                </div>
            `;

            container.innerHTML = featureList + warning + footer;
        }

        // === æ•°æ®ç®¡ç† ===
        function openDataModal() {
            document.getElementById('exportJsonArea').value = JSON.stringify(currentItems);
            document.getElementById('dataModal').style.display = 'flex';
        }

        function copyData() {
            const area = document.getElementById('exportJsonArea');
            area.select();
            document.execCommand('copy');
            alert('æ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }

        function importData(method) {
            try {
                const raw = document.getElementById('importJsonArea').value;
                if (!raw) return;
                const data = JSON.parse(raw);
                if (!Array.isArray(data)) throw new Error("æ ¼å¼é”™è¯¯");

                if (method === 'overwrite') {
                    if(!confirm("ç¡®å®šè¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼Ÿ")) return;
                    currentItems = data;
                } else {
                    // Append: re-id items
                    const offset = Date.now();
                    const newItems = data.map((item, idx) => ({...item, id: offset + idx}));
                    currentItems = currentItems.concat(newItems);
                }
                saveData();
                refreshDisplay();
                alert('å¯¼å…¥æˆåŠŸ');
                document.getElementById('dataModal').style.display = 'none';
            } catch (e) {
                alert('å¯¼å…¥å¤±è´¥ï¼šæ— æ•ˆçš„JSONæ•°æ®');
            }
        }

        function factoryReset() {
            if(confirm("è­¦å‘Šï¼šè¿™å°†åˆ é™¤æ‚¨å½“å‰æ¨¡å¼ä¸‹çš„æ‰€æœ‰è‡ªå®šä¹‰æ•°æ®ï¼Œæ¢å¤è‡³åˆå§‹çŠ¶æ€ã€‚ç¡®å®šå—ï¼Ÿ")) {
                const key = currentMode === 'siphon' ? DB_KEY_SIPHON : DB_KEY_AGENCY;
                localStorage.removeItem(key);
                loadData(); // reload defaults
                alert("å·²æ¢å¤å‡ºå‚è®¾ç½®");
                document.getElementById('dataModal').style.display = 'none';
            }
        }

        // === æ¨¡å¼åˆ‡æ¢ ===
        function handleThemeChange(value) {
            if (value === 'u_entry') {
                const answer = prompt("æ­£åœ¨å°è¯•å»ºç«‹éæ³•è¿æ¥...\nè¯·è¾“å…¥è®¿é—®æ–‡ä»¶åï¼š");
                if (answer && answer.toUpperCase() === 'X2') {
                    activateSiphonMode();
                } else {
                    alert("è®¿é—®è¢«æ‹’ç»ã€‚æœºæ„å®‰ä¿åè®®å·²è®°å½•æ­¤äº‹ä»¶ã€‚");
                    document.getElementById('themeSelector').value = 'standard';
                }
            } else {
                changeTheme(value);
            }
        }

        function changeTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem(SETTING_KEY_THEME, theme);
        }

        function activateSiphonMode() {
            const overlay = document.getElementById('rippleOverlay');
            overlay.classList.add('active'); 
            setTimeout(() => {
                switchMode('siphon');
                overlay.style.opacity = '0'; 
                setTimeout(() => {
                    overlay.classList.remove('active');
                    overlay.style.opacity = ''; 
                }, 500);
            }, 800); 
        }

        function returnToAgency() {
            if(confirm("ç¡®å®šè¦æ–­å¼€ä¸Siphonçš„è¿æ¥å¹¶æ¸…é™¤ç¼“å­˜å—ï¼Ÿ")) {
                switchMode('agency');
                const savedTheme = localStorage.getItem(SETTING_KEY_THEME) || 'standard';
                changeTheme(savedTheme);
                document.getElementById('themeSelector').value = savedTheme;
            }
        }

        function triggerUQuote() {
            if(currentMode === 'siphon') {
                const quote = uQuotes[Math.floor(Math.random() * uQuotes.length)];
                alert(`U çš„ä¿¡æ¯:\n\n"${quote}"`);
            }
        }

        function switchMode(mode) {
            currentMode = mode;
            document.documentElement.setAttribute('data-mode', mode);
            
            const title = document.getElementById('siteTitle');
            const currencySpan = document.getElementById('currencyName');
            const quoteBox = document.getElementById('siphonQuote');
            const themeContainer = document.getElementById('themeSelectorContainer');
            const sourceInput = document.getElementById('itemSource');
            
            const formTitle = document.getElementById('formTitle');
            const itemNameLabel = document.getElementById('itemNameLabel');

            if (mode === 'siphon') {
                title.innerHTML = `SIPHON'S <span class="siphon-patch">SHOP</span>`;
                currencySpan.innerHTML = `<span class="siphon-patch">ç”³è¯«</span>`;
                quoteBox.textContent = uQuotes[Math.floor(Math.random() * uQuotes.length)];
                document.getElementById('agencyExportOptions').style.display = 'none';
                document.getElementById('siphonExportOptions').style.display = 'block';
                if(themeContainer) themeContainer.style.display = 'none';
                sourceInput.setAttribute('list', 'siphonSourceOptions');
                formTitle.innerHTML = `å½•å…¥æ–°<span class="siphon-patch">éæ³•å•†å“</span>`;
                itemNameLabel.innerHTML = `<span class="siphon-patch">å•†å“åç§°</span>`;
            } else {
                title.innerHTML = `TRIANGLE <span>AGENCY</span>`;
                currencySpan.textContent = 'å˜‰å¥–';
                document.getElementById('agencyExportOptions').style.display = 'block';
                document.getElementById('siphonExportOptions').style.display = 'none';
                if(themeContainer) themeContainer.style.display = 'block';
                sourceInput.setAttribute('list', 'agencySourceOptions');
                formTitle.innerHTML = `å½•å…¥æ–°ç”³é¢†ç‰©`;
                itemNameLabel.innerHTML = `ç”³é¢†ç‰©åç§°`;
            }

            resetForm();
            loadData();
        }

        // === æ•°æ®åŠ è½½ä¸ä¿å­˜ ===
        function loadData() {
            const key = currentMode === 'siphon' ? DB_KEY_SIPHON : DB_KEY_AGENCY;
            const data = localStorage.getItem(key);
            
            if (data) {
                currentItems = JSON.parse(data);
            } else {
                if (currentMode === 'siphon') {
                    currentItems = loadDefaultSiphonItems();
                } else {
                    currentItems = loadDefaultAgencyItems(); 
                }
                saveData();
            }
            refreshDisplay();
        }

        function loadDefaultSiphonItems() {
             return [
                { id: 1, name: "åŠ é€Ÿå‘å±•", source: "Siphonçš„å•†åº—", prices: [{label: "æ¿€æ´»", cost: 7}], desc: "æ¿€æ´»â€œç»ƒä¹ â€æˆ–â€œä¸ºäººæ‰€çŸ¥â€ã€‚", image: "", condition: "", purchasedBy: "", starred: true, isNew: true },
                { id: 2, name: "è‡ªæˆ‘å®ç°", source: "Siphonçš„å•†åº—", prices: [{label: "æ›¿æ¢èƒ½åŠ›", cost: 14}], desc: "ä¸å–œæ¬¢ä½ æŸé¡¹å¼‚å¸¸èƒ½åŠ›çš„å‘å±•æ–¹å‘ï¼ŸSiphonèƒ½è®©ä½ çš„è§‚å¯Ÿæˆä¸ºæœ€é‡è¦çš„å› ç´ ï¼Œå¹¶å°†ä½ ç°æœ‰çš„ä¸€é¡¹èƒ½åŠ›ï¼Œæ›¿æ¢ä¸ºä½ æœ¬ä¼šå› ä»¥ä¸åŒæ–¹å¼å›ç­”å‰ä¸€ä¸ªèƒ½åŠ›é—®é¢˜è€Œè·å¾—çš„èƒ½åŠ›ã€‚è¢«æ›¿æ¢æ‰çš„èƒ½åŠ›ä¼šå¤±å»å…¶â€œå·²ç»ƒä¹ â€çŠ¶æ€å’Œä»»ä½•å·²å›ç­”çš„â€œä¸ºäººæ‰€çŸ¥â€é—®é¢˜ã€‚", image: "", condition: "", purchasedBy: "", starred: false, isNew: false },
                { id: 3, name: "ä¼—å¤š", source: "Siphonçš„å•†åº—", prices: [{label: "è·å¾—èƒ½åŠ›", cost: 21}], desc: "ä»ä½ å¤–å‹¤å°é˜Ÿä¸­æ— äººä½¿ç”¨çš„å¼‚å¸¸ARCç»„ä»¶å¤„ï¼Œè·å¾—ä¸€é¡¹åˆå§‹å¼‚å¸¸èƒ½åŠ›ã€‚å®ƒå¯ä»¥åƒæ­£å¸¸èƒ½åŠ›ä¸€æ ·è¿›é˜¶ä¸ºæœªæ¥çš„èƒ½åŠ›ã€‚", image: "", condition: "", purchasedBy: "", starred: false, isNew: false },
                { id: 4, name: "æ½œå…¥", source: "Siphonçš„å•†åº—", prices: [{label: "è·å¾—èƒ½åŠ›", cost: 28}], desc: "ä½ è·å¾—èƒ½åŠ›â€œæ½œå…¥â€ï¼šå½“ä½ æ­»äº¡æ—¶ï¼Œä½ ä¸ä¼šè¿”å›æœºæ„ï¼Œè€Œæ˜¯å å…¥é—¨å…ã€‚ä½ å¯ä»¥é€šè¿‡åœ¨æŸä¸ªæ­£æƒ³ç€ä½ çš„äººé™„è¿‘ç°èº«ï¼Œæ¥è¿…é€Ÿè¿”å›ç°å®ã€‚å½“ä½ è¿”å›æ—¶ï¼Œé€‰æ‹©ä½ èº«ä½“çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå°†æ°¸è¿œæ”¹å˜ä»¥åæ˜ ä½ çš„å¼‚å¸¸ã€‚ä½ ä¸èƒ½ä¸¤æ¬¡é€‰æ‹©åŒä¸€é€‰é¡¹ï¼šå·¦çœ¼ã€å³çœ¼ã€å£é¼»ã€å·¦æ‰‹ã€å³æ‰‹ã€å·¦è‡‚ã€å³è‡‚ã€å·¦è„šã€å³è„šã€å·¦è…¿ã€å³è…¿ã€å¿ƒè„ã€èƒƒ\nè¿™äº›æ”¹å˜å¯èƒ½ä¼šä½¿ä½ ä»…ä»…æ˜¯å­˜åœ¨ï¼Œå°±ä¼šå¼€å§‹åˆ¶é€ æ•£é€¸ç«¯ã€‚", image: "", condition: "", purchasedBy: "", starred: false, isNew: false },
                { id: 5, name: "åˆ†è£‚", source: "Siphonçš„å•†åº—", prices: [{label: "è·å¾—èƒ½åŠ›", cost: 42}], desc: "ä½ è·å¾—èƒ½åŠ›â€œåˆ†è£‚â€ï¼šä½ çš„å¼‚å¸¸ä½“å¯ä»¥å®‰å…¨åœ°è„±ç¦»ä½ çš„èº«ä½“ï¼Œå¹¶è‡ªä¸»è¡ŒåŠ¨ï¼ŒæŒç»­æ—¶é—´ä¸è¶…è¿‡7åˆ†é’Ÿã€‚åœ¨æ­¤æœŸé—´ï¼Œä½ å¯ä»¥ç‹¬ç«‹åœ°æ§åˆ¶ä¸¤è€…ï¼›ä½ çš„äººç±»èº«ä½“æ— æ³•ä½¿ç”¨å¼‚å¸¸èƒ½åŠ›ï¼Œè€Œä½ çš„å¼‚å¸¸å½¢æ€åˆ™ä¼šä¸ºæ¯ä¸ªé­é‡å®ƒçš„äººåˆ¶é€ ä¸€ä¸ªæ•£é€¸ç«¯ã€‚", image: "", condition: "", purchasedBy: "", starred: false, isNew: false },
                { id: 6, name: "é¢†åŸŸåˆ›é€ ", source: "Siphonçš„å•†åº—", prices: [{label: "è·å¾—èƒ½åŠ›", cost: 49}], desc: "ä½ è·å¾—èƒ½åŠ›â€œé¢†åŸŸåˆ›é€ â€ï¼š\næ¯æ¬¡ä»»åŠ¡ä¸­ï¼Œä½ å¯ä»¥å°†ä¸€ä¸ªå°é—­çš„æˆ¿é—´æˆ–ä¸€ä¸ªç›´å¾„çº¦10ç±³çš„å¼€æ”¾ç©ºé—´ï¼Œå»ºç«‹ä¸ºä½ çš„é¢†åŸŸã€‚è¯¥ç©ºé—´ä¸èƒ½ä½äºå¦ä¸€ä¸ªå¼‚å¸¸ä½“çš„é¢†åŸŸä¹‹å†…ï¼Œä¹Ÿä¸èƒ½ä¸ä¹‹æ¥è§¦ã€‚åœ¨ä»»åŠ¡ç»“æŸå‰ï¼Œå®ƒä¸ä¼šæ¶ˆæ•£ã€‚\nä½ çš„é¢†åŸŸå…·æœ‰ä»¥ä¸‹æ•ˆæœï¼šå…¶ä»–å¼‚å¸¸ä½“ï¼ŒåŒ…æ‹¬æ¬¡çº§å¼‚å¸¸ä½“ï¼Œæœªç»ä½ çš„è®¸å¯ä¸å¾—è¿›å…¥ä½ çš„é¢†åŸŸã€‚åœ¨ä½ çš„é¢†åŸŸä¸­ä½¿ç”¨å¼‚å¸¸èƒ½åŠ›æ—¶ï¼ŒæˆåŠŸçš„æ·éª°ä¼šè‡ªåŠ¨è·å¾—ä¸€ä¸ªé¢å¤–çš„ 3ã€‚\næ¯æ¬¡ä»»åŠ¡ä¸­ï¼Œä½ å¯ä»¥åœ¨ä½ çš„é¢†åŸŸå†…æ— éœ€æ·éª°ä¾¿ä½¿ç”¨UNL3ASHä¸€æ¬¡ï¼Œä»…å½±å“é¢†åŸŸå†…çš„äº‹ç‰©ã€‚", image: "", condition: "", purchasedBy: "", starred: false, isNew: false },
                { id: 7, name: "è§‰é†’", source: "Siphonçš„å•†åº—", prices: [{label: "è·å¾—èƒ½åŠ›", cost: 56}], desc: "åˆ›é€ ä¸€é¡¹èƒ½å®Œç¾ä»£è¡¨ä½ çš„å…¨æ–°å¼‚å¸¸èƒ½åŠ›ï¼ŒåŒ…æ‹¬ä¸€ä¸ªæˆåŠŸæ•ˆæœã€ä¸€ä¸ªä¸‰é‡å‡åæ•ˆæœå’Œä¸€ä¸ªå¤±è´¥æ•ˆæœã€‚", image: "", condition: "", purchasedBy: "", starred: false, isNew: false }
            ];
        }
        
        function loadDefaultAgencyItems() {
            return [
                {id: 1, name: "ä¸‰è§’æœºæ„å®˜æ–¹é©¬å…‹æ¯", source: "ä¸‰è”åŸæ€»éƒ¨", prices: [{label: "12ç›å¸", cost: 3}, {label: "18ç›å¸", cost: 18}], desc: "è¿™æ¬¾æ—¶é«¦çš„é™¶ç“·é©¬å…‹æ¯èƒ½ç››æ”¾ä»»ä½•å¤„äºåˆç†æ¸©åº¦èŒƒå›´å†…çš„æ¶²ä½“ã€‚", image: "", condition: "", purchasedBy: "", starred: false, isNew: false},
                {id: 2, name: "ä¾¿åˆ©å›å½¢é’ˆ", source: "ä¸‰è”åŸæ€»éƒ¨", prices: [{label: "ç§Ÿèµ", cost: 1}, {label: "è´­ä¹°", cost: 15}], desc: "è¿™æšä¸€è‹±å¯¸é•¿çš„é‡‘å±å›å½¢é’ˆèƒ½è®©ç‰¹å·¥éšç§˜åœ°å‚¨å­˜ä»»æ„æ•°é‡çš„æ–‡æ¡£æˆ–æ•°å­—æ–‡ä»¶ã€‚\nå°†çº¸è´¨æ–‡ä»¶æ‰£åœ¨ä¸€èµ·å³å¯å‚¨å­˜ï¼Œæˆ–å°†å›å½¢é’ˆçš„ä¸€ç«¯æ’å…¥ä»»ä½•æ•°æ®ç«¯å£ï¼Œå³å¯ä¿å­˜ã€ä¼ è¾“æˆ–å¤åˆ¶æ•°å­—æ•°æ®ã€‚å›å½¢é’ˆçš„å­˜å‚¨æ•°æ®é‡æ²¡æœ‰ä¸Šé™ï¼›ä»»æ„æ•°é‡çš„çº¸å¼ çœ‹èµ·æ¥éƒ½åªä¼šæ˜¯ä¸€å äº”å¼ å·¦å³ã€å¹³å¹³æ— å¥‡çš„çº¸ã€‚è¯·æ³¨æ„ï¼Œå‚¨å­˜åœ¨å›å½¢é’ˆä¸­çš„ä»»ä½•ä¿¡æ¯éƒ½å°†æˆä¸ºæœºæ„è´¢äº§ã€‚", image: "", condition: "", purchasedBy: "", starred: false, isNew: false},
                {id: 3, name: "éšèº«å‚¨ç‰©æŸœ", source: "ä¸‰è”åŸæ€»éƒ¨", prices: [{label: "å°å‹ç§Ÿèµ", cost: 1}, {label: "å¤§å‹ç§Ÿèµ", cost: 3}, {label: "å°å‹è´­ä¹°", cost: 11}, {label: "å¤§å‹è´­ä¹°", cost: 33}], desc: "è¿™ä¸ªé‡‘å±å‚¨ç‰©æŸœç”±å½“å€¼çš„æµå½¢ç»´æŠ¤ï¼Œåœ¨ä»»åŠ¡æœŸé—´å¯éšæ—¶å­˜å–ï¼šå°†æ‰‹ä¸­æŒæœ‰çš„ç‰©ä½“ä¼¸å‘èº«åï¼ˆä»¥å­˜æ”¾ç‰©ä½“ï¼‰ï¼Œæˆ–ç©ºæ‰‹ä¼¸å‘èº«åï¼ˆä»¥å–å‡ºç‰©ä½“ï¼‰ã€‚ç‰©ä½“åœ¨å‚¨ç‰©æŸœä¸­ä¼šæ­£å¸¸è€åŒ–å’ŒæŸè€—ã€‚\nå°å‹å‚¨ç‰©æŸœçš„å°ºå¯¸çº¦ä¸ºä¸€ä¸ªæ™®é€šèƒŒåŒ…å¤§å°ã€‚å¤§å‹å‚¨ç‰©æŸœçš„å°ºå¯¸çº¦ä¸ºä¸€ä¸ªæ™®é€šè½¦åº“å¤§å°ã€‚", image: "", condition: "", purchasedBy: "", starred: false, isNew: false},
                {id: 4, name: "ä¸‰è§’æœºæ„ä¼ä¸šè†³é£Ÿè®¡åˆ’", source: "ä¸‰è”åŸæ€»éƒ¨", prices: [{label: "å•æ¬¡ä»»åŠ¡è†³é£Ÿè®¡åˆ’", cost: 1}, {label: "æ°¸ä¹…è†³é£Ÿè®¡åˆ’", cost: 15}], desc: "å½“æ‚¨ä»ä»»ä½•é¤å…ä¸ºè‡ªå·±ç‚¹é¤æ—¶ï¼Œåªè¦æ‚¨åªç‚¹è¿™ä»½è·å‡†é£Ÿç‰©æ¸…å•ä¸Šçš„èœå“ï¼Œä¾¿å¯ä½¿ç”¨æœºæ„çš„å…¬å¸å¡ï¼š å’–å–±è§’ã€å¯ä¸½é¥¼ï¼ˆæŠ˜å ä¾›åº”ï¼‰ã€é¥­å›¢ã€ä¸‰æ˜æ²»ï¼ˆåˆ‡æˆä¸‰è§’å½¢ï¼‰ã€æŠ«è¨æˆ–æ´¾ï¼ˆæŒ‰ç‰‡ï¼‰ã€å“ˆæ›¼å¡”æ£®ã€ç®­èŸ¹ã€ç‘å£«ä¸‰è§’å·§å…‹åŠ›ã€‚å…¶ä»–é€‰é¡¹å¿…é¡»ç»æ‚¨çš„æ€»ç»ç†æ‰¹å‡†ã€‚", image: "", condition: "", purchasedBy: "", starred: false, isNew: false},
                {id: 5, name: "æ…ˆå–„ææ¬¾", source: "ä¸‰è”åŸæ€»éƒ¨", prices: [{label: "æ„Ÿè°¢æ‚¨çš„æèµ ï¼", cost: 9}], desc: "ä¸€å®¶éšæœºæŠ½é€‰çš„è´«å›°å­¤å„¿é™¢å°†è·å¾—ä¸ºæœŸä¸€å¹´çš„èµ„é‡‘æ”¯æŒã€‚", image: "", condition: "", purchasedBy: "", starred: false, isNew: false},
                {id: 6, name: "ä¸‰è½®è¡Œæ±½è½¦æœåŠ¡", source: "ä¸‰è”åŸæ€»éƒ¨", prices: [{label: "å®¾å®¢é€šè¡Œè¯", cost: 1}, {label: "ç»ˆèº«ä¼šå‘˜", cost: 15}], desc: "æ‚¨å°†è¢«æŒ‡æ´¾ä¸€è¾†è‡ªé€‰çš„ç§äººè½½å…·ã€‚è¯¥è½½å…·å¯ä»¥æ˜¯ä»»ä½•å¸‚å”®çš„ã€å¯åœ¨å…¬è·¯ä¸Šåˆæ³•è¡Œé©¶çš„ç§»åŠ¨ç‰©ä½“ï¼Œå…¶å°ºå¯¸é¡»è¶³ä»¥å®¹çº³æ‚¨çš„æ•´ä¸ªå¤–å‹¤å°é˜Ÿï¼Œå¹¶é…å¤‡ä»»ä½•å¿…è¦çš„è®¾æ–½ã€‚å½’è¿˜å—æŸè½¦è¾†å°†æ‹›è‡´ç”³è¯«ã€‚", image: "", condition: "", purchasedBy: "", starred: false, isNew: false},
                {id: 7, name: "ä¿¡æ¯æŠ«éœ²åè®®", source: "ä¸‰è”åŸæ€»éƒ¨", prices: [{label: "å®¾å®¢é€šè¡Œè¯", cost: 1}, {label: "ä¼šå‘˜", cost: 15}], desc: "å—æœ¬åè®®ä¿æŠ¤çš„ç‰¹å·¥æˆæƒæœºæ„ï¼Œåœ¨åŒæ–¹éƒ½åŒæ„çš„æƒ…å†µä¸‹ï¼Œè½¬å½•å…¶æ€æƒ³å¹¶å°†å…¶ä»–ç‰¹å·¥çš„æ€æƒ³æ¤å…¥å…¶å¿ƒæ™ºï¼Œä»¥ä¿ƒè¿›ç‰¹å·¥é—´çš„æ²Ÿé€šï¼Œå¹¶ä½¿æ‚¨èƒ½æ— éœ€è¨€è¯­ã€è¿œè·ç¦»åœ°è¿›è¡Œäº¤è°ˆã€‚æ‰€æœ‰ç‰¹å·¥éƒ½å¿…é¡»ç­¾ç½²è‡ªå·±çš„ä¿¡æ¯æŠ«éœ²åè®®æ–¹å¯å‚ä¸ã€‚", image: "", condition: "", purchasedBy: "", starred: false, isNew: false},
                {id: 8, name: "ä¸‰è§’æœºæ„å®˜æ–¹è¿åŠ¨å¤¹å…‹", source: "ä¸‰è”åŸæ€»éƒ¨", prices: [{label: "ä»»æ„å°ºç ", cost: 15}], desc: "è¿™æ¬¾è½»ä¾¿é€æ°”çš„å¤¹å…‹èƒ½è®©ç‰¹å·¥åœ¨å½°æ˜¾å…¶æ— å¯æŒ‘å‰”å“å‘³çš„åŒæ—¶ï¼Œä¿æŒèˆ’é€‚ä¸è¡ŒåŠ¨è‡ªå¦‚ã€‚ç‰¹å·¥å¯è¦æ±‚åœ¨èƒŒåä¸ç½‘å°åˆ·å…¶å§“åæˆ–å‘¼å·ï¼Œå³å‰èƒ¸ä¹Ÿé¢„ç•™äº†ç©ºé—´ï¼Œå¯æ·»åŠ ç‰¹å·¥æ¯æ¬¡æ™‹å‡æ—¶è·å¾—çš„åˆºç»£è‡‚ç« ã€‚", image: "", condition: "", purchasedBy: "", starred: false, isNew: false},
                {id: 9, name: "ä¸‰è§’å®¶å±…ç¤¼å“å¡", source: "ä¸‰è”åŸæ€»éƒ¨", prices: [{label: "1000ç¾å…ƒç¤¼å“å¡", cost: 1}, {label: "3,000,000ç¾å…ƒç¤¼å“å¡", cost: 66}], desc: "åœ¨åŠå…¬å®¤æ—¶ï¼Œæˆ–åœ¨ä»»åŠ¡æœŸé—´èº«å¤„è´­ç‰©ä¸­å¿ƒæ—¶ï¼Œæ‚¨å¯ä½¿ç”¨æ­¤ç¤¼å“å¡æ¶ˆè´¹ï¼Œä»¥è´­ä¹°é“å…·ã€å®¶å…·ã€å®¶å±…ç”¨å“ï¼Œä»¥åŠæ‚¨è°ƒæŸ¥å¯èƒ½éœ€è¦çš„ä»»ä½•å…¶ä»–å¸¸è§çš„å‡¡ä¿—ç‰©å“ã€‚å•†å“ä¸å¾—è½¬å”®ã€‚", image: "", condition: "", purchasedBy: "", starred: false, isNew: false},
                {id: 10, name: "éƒ¨é—¨è°ƒåŠ¨ç”³è¯·", source: "ä¸‰è”åŸæ€»éƒ¨", prices: [{label: "é¦–æ¬¡", cost: 15}, {label: "æ­¤åæ¯æ¬¡", cost: 30}], desc: "æ„Ÿè§‰è‡ªå·±ä¸å½“å‰éƒ¨é—¨æ ¼æ ¼ä¸å…¥ï¼Ÿå¯ç”³è¯·å°†æ‚¨çš„èŒèƒ½è°ƒåŠ¨è‡³æ‚¨å½“å‰å¤–å‹¤å°é˜Ÿä¸­å°šæ— ä»£è¡¨çš„ä»»ä½•èŒèƒ½ã€‚è¯·æ³¨æ„ï¼Œæ‚¨åªèƒ½åœ¨ä¸‹æ¬¡ä»»åŠ¡å¼€å§‹æ—¶ï¼Œæ‰èƒ½è·å¾—æ–°èŒèƒ½çš„åˆå§‹ç”³é¢†ç‰©ã€‚", image: "", condition: "", purchasedBy: "", starred: false, isNew: false},
                {id: 11, name: "å†å²ä¿®æ­£ç”³è¯·", source: "ä¸‰è”åŸæ€»éƒ¨", prices: [{label: "æ‰€æœ‰ç”³è¯·", cost: 99}], desc: "æ‚¨å¯åˆ©ç”¨æœºæ„çš„3%é—ªå›è®¡åˆ’ï¼Œæ¥æ”¹å†™æ‚¨è¿‡å»æŸä¸ªç‰¹å®šçš„å‡¡ä¿—æ—¶åˆ»ã€‚è¿™å¯ä»¥æ¶µç›–å„ç§æƒ…å†µï¼Œä»è°ƒæ•´æ‚¨åœ¨ä¸€æ¬¡å†³å®šæ€§è°ˆè¯ä¸­æ‰€è¯´çš„è¯ï¼Œåˆ°æ”¹å˜æ‚¨ä»Šæ—©æ˜¯å¦åœ¨ä¸‰æ˜æ²»é‡ŒåŠ äº†è›‹é»„é…±ã€‚\nè¯·æ³¨æ„ï¼Œæ­¤é¡¹æ“ä½œæ— æ³•å½±å“ä¸å¼‚å¸¸å­˜åœ¨çš„è¿‡å¾€äº’åŠ¨ï¼ŒåŒ…æ‹¬æ‚¨è‡ªå·±çš„ç§äººå¼‚å¸¸ä½“ã€‚", image: "", condition: "", purchasedBy: "", starred: false, isNew: false},
                {id: 12, name: "LMZâ€œç ´å¤©è€…â€æ‰§æ”¿å®˜çº§ç›´å‡æœº", source: "ä¸‰è”åŸæ€»éƒ¨", prices: [{label: "åŸºç¡€æ¬¾", cost: 333}, {label: "é˜²ç«æ¬¾", cost: 999}], desc: "è¿™æ¶é¡¶å°–çš„æœºæ„å“ç‰Œç›´å‡æœºå°†æ‚¨ä»ä¸€åˆ‡é™†åœ°çƒ¦æ¼ä¸­è§£æ”¾å‡ºæ¥ã€‚â€œç ´å¤©è€…â€æ‹¥æœ‰å¯å®¹çº³å¤šè¾¾9åä¹˜å®¢çš„è±ªåçœŸçš®åº§æ¤…ã€è¶…è¿‡300æµ·é‡Œçš„èˆªç¨‹ã€140èŠ‚çš„å·¡èˆªé€Ÿåº¦ã€å¯å®šåˆ¶çš„è‡ªåŠ¨åŠ©æ‰‹ä»¥åŠå†·è—æ¯æ¶ï¼Œæ˜¯å½“ä¹‹æ— æ„§çš„è‡³å°Šå‡ºè¡Œæ–¹å¼ã€‚\nä¸å«é£è¡Œå‘˜åŸ¹è®­ã€‚éœ€ç­¾ç½²è´£ä»»è±å…ä¹¦ã€‚", image: "", condition: "", purchasedBy: "", starred: false, isNew: false},
                {id: 13, name: "é»‘è‰²å¥‡ç¾æ‹‰ç¾Šç©å¶", source: "æ¤°æ±åŸåˆ†éƒ¨", prices: [{label: "æ¯åª", cost: 3}], desc: "ç”¨æ¤°æ±åŸåˆ†éƒ¨æ€»ç»ç†Y2Kçš„ç¾Šæ¯›åˆ¶æˆçš„ç©å¶â€¦â€¦çœ‹ä¸Šå»å°±æ˜¯å°å·Y2Kçš„æ ·å­ã€‚æ‰‹æ„Ÿå¾ˆå¥½ï¼ŒæŠ±ç€ä¹Ÿå¾ˆæš–å’Œã€‚\nå¦‚æœæŠŠå¥‡æ€ªçš„ç¾Šå°¾å·´æ’å…¥æ’åº§ï¼Œé‚£ä¹ˆè¿™ä¸ªç©å¶çš„æ¯›ä¼šå‘çƒ­ï¼Œå¯ä»¥ç”¨æ¥çƒ¤çˆ†ç±³èŠ±å’Œæ£‰èŠ±ç³–ã€‚é™¤æ­¤ä¹‹å¤–æ²¡ä»€ä¹ˆä½œç”¨â€”â€”ä¸è¿‡ä½ çœŸçš„ä¸æƒ³è¦ä¸€åªå¯ä»¥ç”¨æ¥çƒ¤çˆ†ç±³èŠ±å’Œæ£‰èŠ±ç³–çš„ç©å¶ä¹ˆï¼Ÿ", image: "", condition: "", purchasedBy: "", starred: false, isNew: true}
            ];
        }

        function saveData() {
            const key = currentMode === 'siphon' ? DB_KEY_SIPHON : DB_KEY_AGENCY;
            localStorage.setItem(key, JSON.stringify(currentItems));
        }

        // === äº¤äº’åŠŸèƒ½ (åŒ…å«V22é‡å†™çš„æ‹–æ‹½é€»è¾‘) ===
        function addPriceField(label = '', cost = '') {
            const container = document.getElementById('priceContainer');
            const currency = currentMode === 'siphon' ? 'ç”³è¯«' : 'å˜‰å¥–';
            const div = document.createElement('div');
            div.className = 'price-input-row';
            div.innerHTML = `
                <input type="text" placeholder="æ ‡ç­¾" class="p-label" value="${label}" style="flex:2;">
                <input type="number" placeholder="${currency}" class="p-cost" value="${cost}" style="flex:none; width:80px;">
                <button type="button" class="btn-small" style="background:#ddd;color:red;" onclick="this.parentElement.remove()">Ã—</button>
            `;
            container.appendChild(div);
        }

        function saveItem() {
            const name = document.getElementById('itemName').value;
            let source = document.getElementById('itemSource').value;
            const desc = document.getElementById('itemDesc').value;
            const condition = document.getElementById('itemCondition').value;
            const purchasedBy = document.getElementById('itemPurchasedBy').value;
            const isNew = document.getElementById('itemIsNew').checked;
            
            if (!name) { alert("è¯·å¡«å†™åç§°"); return; }
            if (!source) source = currentMode === 'siphon' ? "Siphonçš„å•†åº—" : "ä¸‰è”åŸæ€»éƒ¨";

            const prices = [];
            document.querySelectorAll('.price-input-row').forEach(row => {
                const l = row.querySelector('.p-label').value;
                const c = row.querySelector('.p-cost').value;
                if (c) prices.push({label: l || "èŠ±è´¹", cost: c});
            });

            const itemData = {
                id: editingId || Date.now(),
                name, source, desc, condition, purchasedBy, prices,
                image: tempImageBase64,
                starred: editingId ? (currentItems.find(i=>i.id===editingId)?.starred || false) : false,
                isNew
            };

            if (editingId) {
                const index = currentItems.findIndex(i => i.id === editingId);
                if (index !== -1) currentItems[index] = itemData;
            } else {
                currentItems.push(itemData);
            }

            saveData();
            resetForm();
            refreshDisplay();
        }
        
        function previewImage(input) {
             if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const size = Math.min(img.width, img.height);
                        const startX = (img.width - size) / 2;
                        const startY = (img.height - size) / 2;
                        const finalSize = Math.min(size, 400);
                        canvas.width = finalSize;
                        canvas.height = finalSize;
                        ctx.drawImage(img, startX, startY, size, size, 0, 0, finalSize, finalSize);
                        tempImageBase64 = canvas.toDataURL('image/jpeg', 0.8);
                        const preview = document.getElementById('imagePreview');
                        preview.style.display = 'block';
                        preview.style.background = `url(${tempImageBase64}) center/cover`;
                        preview.innerHTML = '';
                    }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        function toggleImages(shouldRender = true) {
            isImageEnabled = document.getElementById('imageToggle').checked;
            localStorage.setItem(SETTING_KEY_IMG, isImageEnabled);
            document.getElementById('imageUploadGroup').style.display = isImageEnabled ? 'block' : 'none';
            if (shouldRender) refreshDisplay();
        }
        
        function toggleBatchMode() {
            isBatchMode = document.getElementById('batchToggle').checked;
            document.getElementById('batchDeleteBtn').style.display = isBatchMode ? 'block' : 'none';
            if(editingId) resetForm();
            selectedIds.clear();
            refreshDisplay();
        }
        
        function deleteSelected() {
            if (selectedIds.size === 0) return;
            if (confirm(`ç¡®å®šåˆ é™¤ ${selectedIds.size} é¡¹ï¼Ÿ`)) {
                currentItems = currentItems.filter(i => !selectedIds.has(i.id));
                selectedIds.clear();
                saveData();
                refreshDisplay();
            }
        }
        
        function deleteItem(e, id) {
            e.stopPropagation();
            if(confirm("åˆ é™¤æ­¤é¡¹ï¼Ÿ")) {
                currentItems = currentItems.filter(i => i.id !== id);
                if(editingId === id) resetForm();
                saveData();
                refreshDisplay();
            }
        }
        
        function handleCardClick(id) {
            if (isBatchMode) {
                if (selectedIds.has(id)) selectedIds.delete(id);
                else selectedIds.add(id);
                refreshDisplay();
            } else {
                editItem(id);
            }
        }
        
        function editItem(id) {
            const item = currentItems.find(i => i.id === id);
            if (!item) return;
            editingId = id;
            document.getElementById('formTitle').innerText = "ç¼–è¾‘ç‰©å“";
            document.getElementById('saveBtn').innerText = "æ›´æ–°";
            document.getElementById('cancelBtn').style.display = "inline-block";
            document.querySelector('.input-section').classList.add('editing');
            
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemIsNew').checked = item.isNew || false;
            document.getElementById('itemSource').value = item.source;
            document.getElementById('itemDesc').value = item.desc;
            document.getElementById('itemCondition').value = item.condition || "";
            document.getElementById('itemPurchasedBy').value = item.purchasedBy || "";
            tempImageBase64 = item.image || "";
            
            const preview = document.getElementById('imagePreview');
            if (tempImageBase64 && isImageEnabled) {
                preview.style.display = 'block';
                preview.style.background = `url(${tempImageBase64}) center/cover`;
            } else { preview.style.display = 'none'; }
            
            const pContainer = document.getElementById('priceContainer');
            pContainer.innerHTML = '';
            if (item.prices && item.prices.length > 0) item.prices.forEach(p => addPriceField(p.label, p.cost));
            else addPriceField();
            
            document.querySelector('.input-section').scrollIntoView({behavior: 'smooth'});
            refreshDisplay();
        }
        
        function resetForm() {
            editingId = null;
            document.getElementById('formTitle').innerText = "å½•å…¥æ–°ç”³é¢†ç‰©";
            document.getElementById('saveBtn').innerText = "ç¡®è®¤å½•å…¥";
            document.getElementById('cancelBtn').style.display = "none";
            document.querySelector('.input-section').classList.remove('editing');
            document.getElementById('itemName').value = '';
            document.getElementById('itemIsNew').checked = false;
            document.getElementById('itemSource').value = '';
            document.getElementById('itemDesc').value = '';
            document.getElementById('itemCondition').value = '';
            document.getElementById('itemPurchasedBy').value = '';
            document.getElementById('itemImage').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            tempImageBase64 = '';
            document.getElementById('priceContainer').innerHTML = '';
            addPriceField();
            refreshDisplay();
        }
        
        function toggleStar(e, id) {
            e.stopPropagation();
            const item = currentItems.find(i=>i.id===id);
            if(item) { item.starred = !item.starred; saveData(); refreshDisplay(); }
        }

        // === æ‹–æ‹½åŠŸèƒ½ ===
        function handleDragStart(e) {
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.getAttribute('data-id'));
            this.classList.add('dragging');
            setTimeout(() => this.style.opacity = '0.5', 0);
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            
            const draggedId = parseInt(dragSrcEl.getAttribute('data-id'));
            const targetId = parseInt(this.getAttribute('data-id'));
            if (draggedId === targetId) return false;

            const draggedItem = currentItems.find(i => i.id === draggedId);
            const targetItem = currentItems.find(i => i.id === targetId);
            if (!draggedItem || !targetItem) return false;

            if (currentMode === 'agency') {
                const isDraggedHQ = draggedItem.source === "ä¸‰è”åŸæ€»éƒ¨";
                const isTargetHQ = targetItem.source === "ä¸‰è”åŸæ€»éƒ¨";
                if (isDraggedHQ !== isTargetHQ) return false;
            }

            const fromIndex = currentItems.indexOf(draggedItem);
            const toIndex = currentItems.indexOf(targetItem);
            currentItems.splice(fromIndex, 1);
            currentItems.splice(toIndex, 0, draggedItem);
            
            saveData();
            refreshDisplay(); 
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            this.style.opacity = '1';
        }

        // === æ¸²æŸ“é€»è¾‘ ===
        function refreshDisplay(forceItems = null, layoutMode = 'split', filterLabel = '') {
            const container = document.getElementById('exportArea');
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            let items = forceItems ? forceItems : currentItems;
            
            // é»˜è®¤æ’åºå·²è¢«æ‹–æ‹½å–ä»£ï¼Œä»…åœ¨å¿…è¦æ—¶ï¼ˆå¦‚åˆå§‹åŠ è½½æ— é¡ºåºï¼‰å¯è€ƒè™‘æ’åºï¼Œè¿™é‡Œç›´æ¥ç”¨æ•°ç»„é¡ºåº
            
            container.innerHTML = filterLabel ? `<div class="filter-watermark">ç­›é€‰æ¡ä»¶ï¼š${filterLabel}</div>` : '';

            // Siphon æ¨¡å¼ï¼šå•ä¸€å¤§ä¸€ç»Ÿç½‘æ ¼
            if (currentMode === 'siphon') {
                container.className = "requisition-board"; 
                container.style.gridTemplateColumns = "repeat(2, 1fr)";
                
                items.forEach(item => {
                    if (!forceItems && !checkSearch(item, searchText)) return;
                    container.appendChild(createCard(item));
                });
                return;
            }

            // Agency æ¨¡å¼ - V13 é€»è¾‘
            const hqItems = items.filter(i => (!forceItems && !checkSearch(i, searchText)) ? false : i.source === "ä¸‰è”åŸæ€»éƒ¨");
            const branchItems = items.filter(i => (!forceItems && !checkSearch(i, searchText)) ? false : i.source !== "ä¸‰è”åŸæ€»éƒ¨");

            if (layoutMode === 'stacked') {
                container.className = "requisition-board mode-stacked";
                if (hqItems.length > 0) {
                    const sec = document.createElement('div');
                    sec.innerHTML = `<div class="column-header merged-header">ä¸‰è”åŸæ€»éƒ¨ç”³é¢†ç‰©</div><div class="stacked-grid" id="hq-grid"></div>`;
                    container.appendChild(sec);
                    hqItems.forEach(i => sec.querySelector('#hq-grid').appendChild(createCard(i)));
                }
                if (branchItems.length > 0) {
                    const sec = document.createElement('div');
                    sec.innerHTML = `<div class="column-header merged-header" style="border-color:var(--secondary)">åˆ†éƒ¨æä¾›ç”³é¢†ç‰©</div><div class="stacked-grid" id="br-grid"></div>`;
                    container.appendChild(sec);
                    branchItems.forEach(i => sec.querySelector('#br-grid').appendChild(createCard(i)));
                }
            } else {
                container.className = "requisition-board mode-split";
                const hqCol = document.createElement('div'); hqCol.className = 'column';
                hqCol.id = 'hqList'; 
                hqCol.innerHTML = `<div class="column-header"><div style="width:0; height:0; border-left:10px solid transparent; border-right:10px solid transparent; border-bottom:15px solid var(--primary); margin-right:10px;"></div>ä¸‰è”åŸæ€»éƒ¨ç”³é¢†ç‰©</div>`;
                
                const brCol = document.createElement('div'); brCol.className = 'column';
                brCol.id = 'branchList'; 
                brCol.innerHTML = `<div class="column-header"><div style="width:0; height:0; border-left:10px solid transparent; border-right:10px solid transparent; border-bottom:15px solid var(--secondary); margin-right:10px;"></div>åˆ†éƒ¨æä¾›ç”³é¢†ç‰©</div>`;
                
                container.appendChild(hqCol);
                container.appendChild(brCol);
                
                hqItems.forEach(i => hqCol.appendChild(createCard(i)));
                branchItems.forEach(i => brCol.appendChild(createCard(i)));
            }
        }

        function checkSearch(item, text) {
            return (item.name + item.desc + item.source + (item.condition||"") + (item.purchasedBy||"")).toLowerCase().includes(text);
        }

        function createCard(item) {
            const isBranch = item.source !== "ä¸‰è”åŸæ€»éƒ¨" && currentMode === 'agency';
            const themeClass = isBranch ? "blue-theme" : "";
            const currency = currentMode === 'siphon' ? 'ç”³è¯«' : 'å˜‰å¥–';
            
            let imgHtml = isImageEnabled 
                ? (item.image ? `<div class="card-img-box"><img src="${item.image}" class="card-img"></div>` : `<div class="card-img-box"><div class="triangle-placeholder"></div></div>`)
                : '';

            // Siphon è¡¥ä¸é€»è¾‘
            let displayHeader = item.name;
            let currencyDisplay = currency;
            
            if (currentMode === 'siphon') {
                currencyDisplay = `<span class="siphon-patch" style="transform:rotate(1deg);">ç”³è¯«</span>`;
            }

            let pricesHtml = item.prices.map(p => 
                `<div class="price-tag"><span>${p.label}</span><span class="price-divider"></span><span>${p.cost} ${currencyDisplay}</span></div>`
            ).join('');

            let sourceTag = isBranch ? `<span class="branch-tag">${item.source}</span>` : ""; 
            let newBadge = item.isNew ? `<span class="new-badge">NEW</span>` : "";
            
            let footerHtml = '';
            if (item.condition) footerHtml += `<span class="info-tag condition-tag">è·å–æ¡ä»¶: ${item.condition}</span>`;
            if (item.purchasedBy) footerHtml += `<span class="info-tag agent-tag">å·²è´­ä¹°ç‰¹å·¥: ${item.purchasedBy}</span>`;
            if (footerHtml) footerHtml = `<div class="card-footer">${footerHtml}</div>`;

            const isSelected = selectedIds.has(item.id);
            const isEditing = editingId === item.id;
            let selectClass = isBatchMode && isSelected ? 'batch-selected' : '';
            if (isEditing) selectClass = 'is-editing';

            const div = document.createElement('div');
            div.className = `card ${themeClass} ${selectClass}`;
            div.setAttribute('draggable', 'true');
            div.setAttribute('data-id', item.id);
            
            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('dragover', handleDragOver);
            div.addEventListener('drop', handleDrop);
            div.addEventListener('dragend', handleDragEnd);

            div.innerHTML = `
                <div class="card-top">
                    ${imgHtml}
                    <div class="card-meta">
                        <div class="card-header-row">
                            <div class="item-name">${item.name} ${newBadge}</div>
                            <div class="star-icon ${item.starred ? 'active' : ''}" onclick="toggleStar(event, ${item.id})">â˜…</div>
                        </div>
                        ${sourceTag}
                        <div class="price-list">${pricesHtml}</div>
                    </div>
                </div>
                <div class="card-bottom">
                    <div class="item-desc">${item.desc}</div>
                    ${footerHtml}
                </div>
                <div class="delete-btn no-print" onclick="deleteItem(event, ${item.id})">Ã—</div>
            `;
            div.onclick = () => handleCardClick(item.id);
            return div;
        }

        // === å¯¼å‡ºé€»è¾‘ ===
        function openExportModal() { document.getElementById('exportModal').style.display = 'flex'; }
        function closeExportModal() { document.getElementById('exportModal').style.display = 'none'; }

        function runExport() {
            closeExportModal();
            const element = document.querySelector(".main-container");
            const noPrints = document.querySelectorAll('.no-print');
            
            const colFilter = document.querySelector('input[name="colFilter"]:checked').value;
            const layoutStyle = document.querySelector('input[name="layoutStyle"]:checked').value;
            const onlyNew = document.getElementById('exportNew').checked;
            const onlyStar = document.getElementById('exportStar').checked;

            const filteredItems = currentItems.filter(item => {
                if (currentMode === 'agency') {
                    if (colFilter === 'hq' && item.source !== 'ä¸‰è”åŸæ€»éƒ¨') return false;
                    if (colFilter === 'branch' && item.source === 'ä¸‰è”åŸæ€»éƒ¨') return false;
                }
                if (!onlyNew && !onlyStar) return true;
                return (onlyNew && item.isNew) || (onlyStar && item.starred);
            });

            let filterLabel = [];
            if (colFilter !== 'all') filterLabel.push(colFilter);
            if (onlyNew) filterLabel.push("NEW");
            if (onlyStar) filterLabel.push("æ˜Ÿæ ‡");

            const computedStyle = getComputedStyle(document.body);
            const currentBgColor = computedStyle.backgroundColor;

            noPrints.forEach(el => el.style.display = 'none');
            element.style.background = currentBgColor;
            
            const finalLayout = currentMode === 'siphon' ? 'default' : layoutStyle;
            refreshDisplay(filteredItems, finalLayout, filterLabel.join(" + "));

            setTimeout(() => {
                html2canvas(element, {
                    scale: 2,
                    backgroundColor: currentBgColor,
                    windowWidth: 1400,
                    useCORS: true 
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `Triangle_${currentMode}_${new Date().toLocaleDateString()}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                    refreshDisplay(); 
                    noPrints.forEach(el => el.style.display = '');
                    element.style.background = "";
                });
            }, 100);
        }
    </script>
</body>
</html>